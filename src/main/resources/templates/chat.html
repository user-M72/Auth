<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>WebSocket Chat</title>
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
  <style>
    body { font-family: Arial; background: #f3f4f6; display: flex; justify-content: center; align-items: center; height: 100vh; margin:0; }
    .chat-container { background:white; width:450px; border-radius:12px; display:flex; flex-direction:column; overflow:hidden; box-shadow:0 4px 12px rgba(0,0,0,0.15);}
    .chat-header { background:#2563eb; color:white; padding:15px; text-align:center; font-weight:bold; }
    .chat-messages { flex:1; padding:15px; overflow-y:auto; list-style:none; margin:0; display:flex; flex-direction:column; }
    .chat-messages li { margin-bottom:10px; padding:8px 12px; border-radius:10px; max-width:80%; word-wrap:break-word; }
    .chat-messages .own { background:#dbeafe; align-self:flex-end; }
    .chat-messages .other { background:#f1f5f9; align-self:flex-start; }
    .chat-input { display:flex; border-top:1px solid #e5e7eb; }
    .chat-input input { border:none; padding:12px; flex:1; outline:none; }
    .chat-input button { background:#2563eb; color:white; border:none; padding:12px 18px; cursor:pointer; }
    .chat-input select { padding:12px; border:1px solid #e5e7eb; margin-right:5px; }
  </style>
</head>
<body>

<div class="chat-container">
  <div id="chatHeader" class="chat-header">üí¨ WebSocket Chat (–û–±—â–∏–π)</div>
  <div style="padding:0 15px; margin-bottom:10px;">
    <label>–í—ã–±—Ä–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
    <select id="userSelect" onchange="changeChatHeader()">
      <option value="">–û–±—â–∏–π —á–∞—Ç</option>
    </select>
  </div>
  <ul id="messages" class="chat-messages"></ul>
  <div class="chat-input">
    <input id="text" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ" onkeypress="if(event.key==='Enter') sendMessage()">
    <button id="sendBtn" onclick="sendMessage()" disabled>‚û§</button>
  </div>
</div>

<script>
  let stompClient = null;
  let currentUser = localStorage.getItem("username");
  let messagesByUser = { "": [] }; // "" - –æ–±—â–∏–π —á–∞—Ç

  function connect() {
      let token = localStorage.getItem("jwtToken");
      if(!token){ alert("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ!"); return; }

      let socket = new SockJS('/ws');
      stompClient = Stomp.over(socket);

      stompClient.connect({ Authorization: "Bearer " + token }, function(frame){
          document.getElementById("sendBtn").disabled = false;

          // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –æ–¥–∏–Ω —Ç–æ–ø–∏–∫ –¥–ª—è –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
          stompClient.subscribe('/topic/messages', function(message){
              let msg = JSON.parse(message.body);

              // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–ª—é—á —á–∞—Ç–∞
              let chatKey = msg.to ? (msg.from === currentUser ? msg.to : msg.from) : "";
              if(!messagesByUser[chatKey]) messagesByUser[chatKey] = [];
              messagesByUser[chatKey].push(msg);

              // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∞—è –≤–∫–ª–∞–¥–∫–∞
              let selected = document.getElementById("userSelect").value;
              if(selected === chatKey) renderMessages(chatKey);
          });

          // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
          fetch("/users", { headers: { "Authorization": "Bearer " + token }})
          .then(res => res.json())
          .then(users => {
              let select = document.getElementById("userSelect");
              select.innerHTML = '<option value="">–û–±—â–∏–π —á–∞—Ç</option>';
              users.forEach(u=>{
                  if(u!==currentUser){
                      let o = document.createElement("option");
                      o.value = u;
                      o.textContent = u;
                      select.appendChild(o);
                  }
              });
          });
      });
  }

  function sendMessage(){
      let text = document.getElementById("text").value.trim();
      if(!text) return;

      let toUser = document.getElementById("userSelect").value || null;
      let payload = { text, to: toUser };
      stompClient.send(toUser ? "/app/chat/private" : "/app/chat", {}, JSON.stringify(payload));
      document.getElementById("text").value = "";
  }

  function renderMessages(chatKey){
      let list = document.getElementById("messages");
      list.innerHTML = "";
      (messagesByUser[chatKey] || []).forEach(msg => showMessage(msg, chatKey));
  }

  function showMessage(msg, chatKey){
      let li = document.createElement("li");
      if(chatKey){
          if(msg.from===currentUser){
              li.textContent = "–Ø (–¥–ª—è "+msg.to+"): "+msg.text;
              li.classList.add("own");
          } else {
              li.textContent = msg.from+" (–ª–∏—á–Ω–æ): "+msg.text;
              li.classList.add("other");
          }
      } else {
          li.textContent = msg.from+": "+msg.text;
          li.classList.add(msg.from===currentUser?"own":"other");
      }
      document.getElementById("messages").appendChild(li);
      li.scrollIntoView({behavior:"smooth"});
  }

  function changeChatHeader(){
      let select = document.getElementById("userSelect");
      let chatHeader = document.getElementById("chatHeader");
      let val = select.value;
      chatHeader.textContent = val ? "üí¨ Chat —Å "+val : "üí¨ WebSocket Chat (–û–±—â–∏–π)";
      renderMessages(val);
  }

  window.onload = connect;
</script>
</body>
</html>
