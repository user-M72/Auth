<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>WebSocket Chat</title>
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
  <style>
    body {
        font-family: Arial, sans-serif;
        background: #f3f4f6;
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
    }
    .chat-container {
        background: white;
        width: 400px;
        max-width: 90%;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    .chat-header {
        background: #2563eb;
        color: white;
        padding: 15px;
        text-align: center;
        font-weight: bold;
        font-size: 18px;
    }
    .chat-messages {
        flex: 1;
        padding: 15px;
        overflow-y: auto;
        list-style: none;
        margin: 0;
    }
    .chat-messages li {
        margin-bottom: 10px;
        padding: 8px 12px;
        border-radius: 10px;
        max-width: 80%;
        word-wrap: break-word;
    }
    .chat-messages .own {
        background: #dbeafe;
        align-self: flex-end;
        margin-left: auto;
    }
    .chat-messages .other {
        background: #f1f5f9;
        align-self: flex-start;
    }
    .chat-input {
        display: flex;
        border-top: 1px solid #e5e7eb;
    }
    .chat-input input {
        border: none;
        padding: 12px;
        flex: 1;
        outline: none;
        font-size: 14px;
    }
    .chat-input button {
        background: #2563eb;
        color: white;
        border: none;
        padding: 12px 18px;
        cursor: pointer;
        font-size: 14px;
        transition: background 0.2s;
    }
    .chat-input button:disabled {
        background: #94a3b8;
        cursor: not-allowed;
    }
    .chat-input button:hover:enabled {
        background: #1e40af;
    }
  </style>
</head>
<body>
<div class="chat-container">
  <div class="chat-header">üí¨ WebSocket Chat</div>
  <ul id="messages" class="chat-messages"></ul>
  <div class="chat-input">
    <input id="text" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ" onkeypress="if(event.key==='Enter') sendMessage()">
    <button id="sendBtn" onclick="sendMessage()" disabled>‚û§</button>
  </div>
</div>

<script>
  let stompClient = null;

  function connect() {
      let token = localStorage.getItem("jwtToken");
      if (!token) {
          alert("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É!");
          return;
      }

      let socket = new SockJS('/ws');
      stompClient = Stomp.over(socket);

      stompClient.connect(
          { Authorization: "Bearer " + token },
          function () {
              console.log("‚úÖ Connected to WebSocket");
              document.getElementById("sendBtn").disabled = false;

              stompClient.subscribe('/topic/message', function (message) {
                  let msg = JSON.parse(message.body);

                  let li = document.createElement("li");
                  li.textContent = msg.from + ": " + msg.text;

                  if (msg.from === "me") {
                      li.classList.add("own");
                  } else {
                      li.classList.add("other");
                  }

                  document.getElementById("messages").appendChild(li);
                  li.scrollIntoView({behavior: "smooth"});
              });
          },
          function (error) {
              console.error("‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:", error);
              alert("–û—à–∏–±–∫–∞ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ–∫–µ–Ω!");
          }
      );
  }

  function sendMessage() {
      if (!stompClient || !stompClient.connected) {
          alert("–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å WebSocket!");
          return;
      }

      let text = document.getElementById("text").value.trim();
      if (text === "") return;

      stompClient.send("/app/chat", {}, JSON.stringify({ text: text }));
      document.getElementById("text").value = "";
  }


  window.onload = connect;
</script>
</body>
</html>
